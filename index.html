<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poke House ‚Äì Treino v4.05 Clean</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Segoe UI"', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'], // System UI font
                    },
                    colors: {
                        brand: {
                            pink: '#E91E63',
                            blue: '#2196F3',
                            green: '#4CAF50',
                            yellow: '#FFC107',
                            dark: '#212121',
                        },
                        surface: {
                            DEFAULT: '#FFFFFF',
                            hover: '#F8F9FA',
                            active: '#F1F3F5',
                            border: '#E0E0E0'
                        },
                        bg: {
                            DEFAULT: '#F5F5F5',
                        }
                    },
                    boxShadow: {
                        'fluent': '0 2px 4px rgba(0, 0, 0, 0.05), 0 4px 8px rgba(0, 0, 0, 0.05)',
                        'fluent-hover': '0 4px 8px rgba(0, 0, 0, 0.08), 0 8px 16px rgba(0, 0, 0, 0.08)',
                    },
                    borderRadius: {
                        'win': '8px', // Windows 11 style rounded corners
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.3s ease-out forwards',
                        'slide-up': 'slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: linear-gradient(135deg, #f0f4f8 0%, #eef2f5 100%);
            color: #212121;
            touch-action: manipulation;
            font-feature-settings: "cv11", "ss01";
        }
        
        /* Fundo estilo Windows 11 Bloom simplificado */
        .win11-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background: 
                radial-gradient(circle at 0% 0%, rgba(233, 30, 99, 0.08) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(33, 150, 243, 0.08) 0%, transparent 50%);
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #CBD5E1; border-radius: 3px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94A3B8; }
        
        /* Transi√ß√µes suaves */
        .btn-transition { transition: all 0.2s cubic-bezier(0.33, 1, 0.68, 1); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- √çCONES (Lucide Style - Minimalista) ---
        const IconHome = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>);
        const IconArrowLeft = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>);
        const IconArrowRight = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>);
        const IconRotate = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>);
        const IconCheck = ({ size = 24 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"/></svg>);
        const IconList = ({ size = 18 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>);
        const IconX = ({ size = 20 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>);

        // --- DADOS ---
        const SUCCESS_MESSAGES = ["Ficou perfeita! Excelente trabalho.", "Estudou direitinho! A bowl est√° correta.", "Igualzinha ao SOP! Continue assim.", "Mem√≥ria impec√°vel! Parab√©ns."];
        const FAIL_MESSAGES = ["Aten√ß√£o aos detalhes. Vamos revisar?", "N√£o est√° correto. O cliente reclamaria.", "Cuidado com a receita. Tente novamente."];
        const PA_NAMES = { MALE: ["Pedro", "Paulo", "Francisco", "Heitor", "Marcelo", "Jos√©"], FEMALE: ["In√™s", "Eliz", "Melissa", "Mariana", "Vilma", "Bruna"] };
        const PA_EMOJIS = { MALE: ["üë®", "üßîüèª", "üë®üèø", "üë®üèø‚Äçü¶∞"], FEMALE: ["üë©üèª", "üë©üèª‚Äçü¶∞", "üë©üèø", "üë©"] };
        const FINAL_CUSTOM_PHRASES = ["Ficou linda sua bowl!", "Bom apetite!", "Prontinho! Experimente nosso sumo.", "Muito obrigado, volte sempre!"];

        const CHANGELOG = [
            { version: "4.05", date: "Atual", changes: ["Interface Windows 11 Clean.", "Removido fundo do oceano.", "Otimiza√ß√£o de performance.", "Corre√ß√£o do timer."] },
            { version: "4.04", date: "Anterior", changes: ["Ajuste nos bot√µes do menu."] },
            { version: "4.03", date: "Anterior", changes: ["Bot√£o Voltar inteligente.", "Corre√ß√µes de texto."] },
            { version: "4.02", date: "Anterior", changes: ["Lista de receitas restaurada."] },
            { version: "4.0", date: "Anterior", changes: ["Modo 'Crie sua pr√≥pria bowl'."] }
        ];

        const INGREDIENTS_DB = {
            sizes: ["Regular", "Large"],
            bases: ["Arroz de sushi", "Arroz preto", "Quinoa", "Arroz basmati", "Coconut Basmati", "Espinafres", "Winter Salad"],
            sauces_base: ["Azeite", "Azeite de Lim√£o", "Vinagrete", "Ponzu", "Sriracha Mayo", "N√£o leva"],
            greens: ["Batata Doce com Alecrim", "Br√≥colis", "Pickle Cebola", "Beterraba", "Cenoura c/ Soja", "Milho", "Abacaxi", "Edamame", "Tomate Cherry", "Couve roxa", "Courgette", "Cenoura", "Grana Padano", "Pepino", "Feta", "Jalape√±os", "Azeitonas", "Abacate", "Philadelphia", "Wakame", "Manga", "Hummus", "Hortel√£ (Fresca)"],
            proteins: ["Salm√£o Braseado", "Fil√© de Salm√£o", "Frango Vietnamita", "Camar√£o Panado", "Frango", "Frango Teriyaki", "Camar√£o", "Juicy Salmon", "Juicy Tuna", "Salm√£o", "Atum", "Tofu Grelhado", "Ovo", "N√£o leva", "Wakame"],
            sauces_final: ["Creamy Caesar", "Creme de Abacate", "Spicy Peanuts", "Mel", "Chipotle", "S√©samo Shoyu", "Sriracha Mayo", "Wasabi Mayo", "Azeite", "Azeite de Lim√£o", "Manjeric√£o e Hortel√£", "Vinagrete", "Soja", "Teriyaki", "Ponzu", "Especial", "Soja e S√©samo"],
            crispies: ["Cebola frita", "Ervilhas Wasabi", "Algas Nori", "Am√™ndoa", "Batata Doce", "Lima", "Bacon", "Croutons", "Batata Doce Crocante", "N√£o leva", "Cebola Crocante"],
            sesame: ["Sim", "N√£o"],
            smoothie_liquid: ["Leite de Coco", "Leite", "Suco de Ma√ß√£"],
            smoothie_amount: ["150ml", "250ml", "200ml"],
            smoothie_ingredients: ["Morango", "Banana 90g", "Manga 40g", "Anan√°s 30g", "Pepino 20g", "Abacate 45g", "Espinafre 30g", "Sumo de Lima 25g", "Gengibre 5g"],
            smoothie_ice: ["Gelo 60g", "Gelo 40g", "Gelo 90g"],
            smoothie_mode: ["Modo A", "Modo B", "Modo C", "Modo D", "Modo E", "Modo F"]
        };

        const RECIPES = [
            // HOUSE BOWLS
            { id: 1, category: "HOUSE", name: "Sunny Salmon", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Couve roxa", "Edamame"], protein: ["Juicy Salmon", "Juicy Salmon"], sauce_final: ["Especial", "Creme de Abacate"], crispy: ["N√£o leva"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Couve roxa", "Couve roxa", "Edamame", "Edamame"], protein: ["Juicy Salmon", "Juicy Salmon", "Juicy Salmon"], sauce_final: ["Especial", "Creme de Abacate"], crispy: ["N√£o leva"], sesame: ["Sim"] } } },
            { id: 2, category: "HOUSE", name: "Spicy Tuna", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Couve roxa", "Pepino", "Cenoura"], protein: ["Atum", "Atum", "Wakame"], sauce_final: ["Ponzu", "Spicy Peanuts"], crispy: ["Cebola frita"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Couve roxa", "Couve roxa", "Pepino", "Pepino", "Cenoura"], protein: ["Atum", "Atum", "Atum", "Wakame"], sauce_final: ["Ponzu", "Spicy Peanuts"], crispy: ["Cebola frita"], sesame: ["Sim"] } } },
            { id: 3, category: "HOUSE", name: "Vegetarian", variants: { "Regular": { base: ["Arroz basmati", "Arroz basmati"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Hummus", "Hummus", "Tomate Cherry", "Pepino", "Azeitonas"], protein: ["N√£o leva"], sauce_final: ["Manjeric√£o e Hortel√£"], crispy: ["Am√™ndoa"], sesame: ["N√£o"] }, "Large": { base: ["Arroz basmati", "Arroz basmati", "Arroz basmati"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Hummus", "Hummus", "Hummus", "Tomate Cherry", "Pepino", "Azeitonas", "Azeitonas"], protein: ["N√£o leva"], sauce_final: ["Manjeric√£o e Hortel√£"], crispy: ["Am√™ndoa"], sesame: ["N√£o"] } } },
            { id: 4, category: "HOUSE", name: "Chicken", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Couve roxa", "Tomate Cherry", "Courgette"], protein: ["Frango Teriyaki", "Frango Teriyaki"], sauce_final: ["Teriyaki", "Sriracha Mayo"], crispy: ["Am√™ndoa"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Couve roxa", "Couve roxa", "Tomate Cherry", "Courgette", "Courgette"], protein: ["Frango Teriyaki", "Frango Teriyaki", "Frango Teriyaki"], sauce_final: ["Teriyaki", "Sriracha Mayo"], crispy: ["Am√™ndoa"], sesame: ["Sim"] } } },
            { id: 5, category: "HOUSE", name: "Fire Salmon", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["Sriracha Mayo"], greens: ["Jalape√±os", "Tomate Cherry", "Pepino"], protein: ["Salm√£o", "Salm√£o"], sauce_final: ["Sriracha Mayo"], crispy: ["Cebola frita"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["Sriracha Mayo"], greens: ["Jalape√±os", "Tomate Cherry", "Pepino", "Pepino"], protein: ["Salm√£o", "Salm√£o", "Salm√£o"], sauce_final: ["Sriracha Mayo"], crispy: ["Cebola frita"], sesame: ["Sim"] } } },
            { id: 6, category: "HOUSE", name: "Mixed Seas", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Manga", "Wakame", "Cenoura", "Pickle Cebola"], protein: ["Atum", "Salm√£o"], sauce_final: ["Ponzu"], crispy: ["Ervilhas Wasabi"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Manga", "Wakame", "Cenoura", "Cenoura", "Pickle Cebola"], protein: ["Atum", "Salm√£o", "Salm√£o"], sauce_final: ["Ponzu"], crispy: ["Ervilhas Wasabi"], sesame: ["Sim"] } } },
            { id: 7, category: "HOUSE", name: "Crispy Shrimp", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Philadelphia", "Manga", "Pepino"], protein: Array(8).fill("Camar√£o Panado"), sauce_final: ["Teriyaki", "Sriracha Mayo"], crispy: ["Algas Nori"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Philadelphia", "Manga", "Pepino", "Pepino"], protein: Array(12).fill("Camar√£o Panado"), sauce_final: ["Teriyaki", "Sriracha Mayo"], crispy: ["Algas Nori"], sesame: ["Sim"] } } },
            { id: 8, category: "HOUSE", name: "Salmon Sushi", variants: { "Regular": { base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Philadelphia", "Edamame"], protein: ["Salm√£o Braseado", "Salm√£o Braseado"], sauce_final: ["Teriyaki"], crispy: ["Cebola Crocante"], sesame: ["Sim"] }, "Large": { base: ["Arroz de sushi", "Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Philadelphia", "Edamame", "Edamame"], protein: ["Salm√£o Braseado", "Salm√£o Braseado", "Salm√£o Braseado"], sauce_final: ["Teriyaki"], crispy: ["Cebola Crocante"], sesame: ["Sim"] } } },
            { id: 9, category: "GREEN", name: "The Caesar", variants: { "Regular": { base: ["Winter Salad", "Winter Salad", "Winter Salad"], sauce_base: ["Vinagrete"], greens: ["Tomate Cherry", "Tomate Cherry", "Grana Padano"], protein: ["Frango", "Frango", "Frango"], sauce_final: ["Creamy Caesar"], crispy: ["Bacon", "Croutons", "Lima"], sesame: ["N√£o"] } } },
            { id: 10, category: "GREEN", name: "Exotic Salmon", variants: { "Regular": { base: ["Coconut Basmati", "Espinafres", "Espinafres", "Espinafres"], sauce_base: ["Azeite de Lim√£o"], greens: ["Batata Doce com Alecrim", "Batata Doce com Alecrim", "Br√≥colis", "Abacate"], protein: ["Fil√© de Salm√£o", "Fil√© de Salm√£o", "Fil√© de Salm√£o"], sauce_final: ["Sriracha Mayo"], crispy: ["N√£o leva"], sesame: ["N√£o"] } } },
            { id: 11, category: "GREEN", name: "Velvet Garden", variants: { "Regular": { base: ["Winter Salad", "Winter Salad", "Winter Salad"], sauce_base: ["Vinagrete"], greens: ["Cenoura c/ Soja", "Beterraba", "Azeitonas", "Pickle Cebola", "Feta", "Feta", "Feta"], protein: ["N√£o leva"], sauce_final: ["Manjeric√£o e Hortel√£"], crispy: ["N√£o leva"], sesame: ["N√£o"] } } },
            { id: 12, category: "GREEN", name: "Cozy Chicken", variants: { "Regular": { base: ["Coconut Basmati", "Espinafres", "Espinafres"], sauce_base: ["Azeite de Lim√£o"], greens: ["Br√≥colis", "Batata Doce com Alecrim", "Couve roxa", "Courgette"], protein: ["Frango Vietnamita", "Frango Vietnamita", "Frango Vietnamita"], sauce_final: ["Soja"], crispy: ["N√£o leva"], sesame: ["N√£o"] } } },
            { id: 13, category: "SMOOTHIE", name: "Into the Sun", smoothie_liquid: ["Leite de Coco"], smoothie_amount: ["150ml"], smoothie_ingredients: ["Manga 40g", "Manga 40g", "Anan√°s 30g", "Anan√°s 30g", "Banana 90g"], smoothie_ice: ["Gelo 60g"], smoothie_mode: ["Modo E", "Modo E"] },
            { id: 14, category: "SMOOTHIE", name: "Sweet Pink", smoothie_liquid: ["Leite"], smoothie_amount: ["150ml"], smoothie_ingredients: ["Morango", "Morango", "Morango", "Morango", "Banana 90g"], smoothie_ice: ["Gelo 60g"], smoothie_mode: ["Modo E", "Modo E"] },
            { id: 15, category: "SMOOTHIE", name: "So Green", smoothie_liquid: ["Suco de Ma√ß√£"], smoothie_amount: ["250ml"], smoothie_ingredients: ["Pepino 20g", "Abacate 45g", "Espinafre 30g", "Sumo de Lima 25g", "Gengibre 5g"], smoothie_ice: ["Gelo 60g"], smoothie_mode: ["Modo E", "Modo E"] }
        ];

        const PHASES_BOWL = [{ key: "size", title: "Tamanho" }, { key: "base", title: "Base" }, { key: "sauce_base", title: "Molho da base" }, { key: "greens", title: "Greens" }, { key: "protein", title: "Prote√≠na" }, { key: "sauce_final", title: "Molho final" }, { key: "crispy", title: "Crispy" }, { key: "sesame", title: "S√©samo" }];
        const PHASES_SMOOTHIE = [{ key: "smoothie_liquid", title: "L√≠quido" }, { key: "smoothie_amount", title: "Quantidade" }, { key: "smoothie_ingredients", title: "Ingredientes" }, { key: "smoothie_ice", title: "Gelo" }, { key: "smoothie_mode", title: "Blender" }];

        const playSound = (type) => { const AudioContext = window.AudioContext || window.webkitAudioContext; if (!AudioContext) return; const ctx = new AudioContext(); const osc = ctx.createOscillator(); const gain = ctx.createGain(); osc.connect(gain); gain.connect(ctx.destination); const now = ctx.currentTime; if (type === "happy") { osc.type = "sine"; osc.frequency.setValueAtTime(600, now); osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1); gain.gain.setValueAtTime(0.05, now); gain.gain.exponentialRampToValueAtTime(0.001, now + 0.1); osc.start(); osc.stop(now + 0.1); } else { osc.type = "triangle"; osc.frequency.setValueAtTime(150, now); osc.frequency.linearRampToValueAtTime(100, now + 0.2); gain.gain.setValueAtTime(0.05, now); gain.gain.linearRampToValueAtTime(0.001, now + 0.2); osc.start(); osc.stop(now + 0.2); } };
        function shuffleArray(array) { let currentIndex = array.length, randomIndex; while (currentIndex != 0) { randomIndex = Math.floor(Math.random() * currentIndex); currentIndex--; [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]]; } return array; }

        // --- COMPONENTES VISUAIS ---
        const MessageBubble = ({ text }) => (
            <div className="font-sans text-brand-dark text-lg leading-relaxed bg-white p-6 rounded-win shadow-fluent border border-surface-border animate-slide-up max-w-lg mx-auto">
                {text}
            </div>
        );

        const EASTER_EGG_EMOJIS = ['ü•ë','üçÖ','ü´õ','ü•ï','ü´í','üåΩ','üßÖ','ü•¶','üçì','ü•≠','üçç','üç£','üç§','üç™','ü•ó','üßÄ','ü•ö','ü•î'];
        const FoodRain = ({ trigger, quantity = 1 }) => {
            const canvasRef = React.useRef(null);
            const particlesRef = React.useRef([]);
            React.useEffect(() => {
                if (!trigger || trigger === 0) return;
                const canvas = canvasRef.current;
                if (!canvas) return;
                const newParticles = [];
                for (let i = 0; i < quantity; i++) {
                    const floorY = canvas.height + 50;
                    newParticles.push({ x: Math.random() * canvas.width, y: -50, vx: (Math.random() - 0.5) * 5, vy: 5 + Math.random() * 5, gravity: 0.1, emoji: EASTER_EGG_EMOJIS[Math.floor(Math.random() * EASTER_EGG_EMOJIS.length)], size: 24 + Math.random() * 16, life: 1.0 });
                }
                particlesRef.current = [...particlesRef.current, ...newParticles];
            }, [trigger, quantity]);
            React.useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext("2d");
                const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                window.addEventListener("resize", resize); resize();
                let animId;
                const render = () => {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    particlesRef.current = particlesRef.current.filter(p => p.y < canvas.height + 100);
                    particlesRef.current.forEach(p => {
                        p.y += p.vy; p.x += p.vx;
                        ctx.font = `${p.size}px sans-serif`; ctx.fillText(p.emoji, p.x, p.y);
                    });
                    if(particlesRef.current.length > 0) animId = requestAnimationFrame(render);
                };
                render();
                return () => { window.removeEventListener("resize", resize); cancelAnimationFrame(animId); };
            }, [trigger]);
            return <canvas ref={canvasRef} className="fixed inset-0 w-full h-full pointer-events-none z-50" />;
        };

        const PopupModal = ({ message, onConfirm }) => (
            <div className="fixed inset-0 z-[100] flex items-center justify-center bg-black/30 backdrop-blur-sm animate-fade-in">
                <div className="bg-white p-8 rounded-win shadow-fluent-hover border border-surface-border max-w-sm w-full mx-4 text-center transform scale-100 animate-slide-up">
                    <p className="text-lg font-medium text-brand-dark mb-8">{message}</p>
                    <button onClick={onConfirm} className="bg-brand-blue text-white px-6 py-2 rounded-win font-semibold hover:bg-blue-600 transition-colors shadow-sm">Entendido</button>
                </div>
            </div>
        );

        const ChangelogModal = ({ onClose }) => (
            <div className="fixed inset-0 z-[60] bg-black/40 flex items-center justify-center p-4 backdrop-blur-sm animate-fade-in">
                <div className="bg-white rounded-win p-6 max-w-md w-full max-h-[80vh] overflow-y-auto shadow-fluent-hover relative animate-slide-up">
                    <div className="flex justify-between items-center mb-6">
                        <h3 className="font-bold text-xl text-brand-dark flex items-center gap-2"><IconList /> Hist√≥rico</h3>
                        <button onClick={onClose} className="text-gray-400 hover:text-brand-dark transition-colors"><IconX /></button>
                    </div>
                    <div className="space-y-6">{CHANGELOG.map((item, index) => (<div key={index} className="border-l-2 border-brand-blue pl-4"><div className="flex justify-between items-baseline mb-1"><span className="font-semibold text-brand-dark">v{item.version}</span><span className="text-xs text-gray-500 uppercase">{item.date}</span></div><ul className="list-disc list-inside text-sm text-gray-600 space-y-1">{item.changes.map((change, i) => (<li key={i}>{change}</li>))}</ul></div>))}</div>
                </div>
            </div>
        );

        // --- APP PRINCIPAL ---
        function App() {
            const [gameState, setGameState] = React.useState("HOME");
            const [menuCategory, setMenuCategory] = React.useState(null); 
            const [selectedRecipe, setSelectedRecipe] = React.useState(null);
            const [selectedSize, setSelectedSize] = React.useState(null); 
            const [currentPhaseIndex, setCurrentPhaseIndex] = React.useState(0);
            const [currentSelections, setCurrentSelections] = React.useState([]);
            const [allSelections, setAllSelections] = React.useState({});
            const [phaseOptions, setPhaseOptions] = React.useState([]);
            const [timer, setTimer] = React.useState(20);
            const [errorDetails, setErrorDetails] = React.useState([]);
            const [showChangelog, setShowChangelog] = React.useState(false);
            const [resultMessage, setResultMessage] = React.useState("");
            
            const [customPhase, setCustomPhase] = React.useState(0);
            const [paPersona, setPaPersona] = React.useState({ name: "", emoji: "" });
            const [showPopup, setShowPopup] = React.useState(null);
            const [easterEggTrigger, setEasterEggTrigger] = React.useState(0);

            const handleEasterEggClick = () => { if (window.innerWidth < 768) { setEasterEggTrigger(prev => prev + 1); } };

            const getCurrentPhases = () => { if (selectedRecipe?.category === "SMOOTHIE") return PHASES_SMOOTHIE; return PHASES_BOWL; };
            const getFullIngredientList = (key) => { if(key === 'base') return INGREDIENTS_DB.bases; if(key === 'sauce_base') return INGREDIENTS_DB.sauces_base; if(key === 'greens') return INGREDIENTS_DB.greens; if(key === 'protein') return INGREDIENTS_DB.proteins; if(key === 'sauce_final') return INGREDIENTS_DB.sauces_final; if(key === 'crispy') return INGREDIENTS_DB.crispies; if(key === 'sesame') return INGREDIENTS_DB.sesame; if(key === 'smoothie_liquid') return INGREDIENTS_DB.smoothie_liquid; if(key === 'smoothie_amount') return INGREDIENTS_DB.smoothie_amount; if(key === 'smoothie_ingredients') return INGREDIENTS_DB.smoothie_ingredients; if(key === 'smoothie_ice') return INGREDIENTS_DB.smoothie_ice; if(key === 'smoothie_mode') return INGREDIENTS_DB.smoothie_mode; return []; };
            const getCurrentPhaseData = () => { if(!selectedRecipe) return {}; const phases = getCurrentPhases(); return phases[currentPhaseIndex]; };
            const getSelectionLimit = () => { if (!selectedRecipe) return 0; const phaseKey = getCurrentPhases()[currentPhaseIndex].key; if (phaseKey === "size") return 1; if (selectedRecipe.category === "SMOOTHIE") { return selectedRecipe[phaseKey].length; } else { const sizeToUse = selectedSize || "Regular"; return selectedRecipe.variants[sizeToUse] ? selectedRecipe.variants[sizeToUse][phaseKey].length : 0; } };

            // Timer Logic Fix
            React.useEffect(() => {
                let interval;
                if (gameState === "PLAYING") {
                    interval = setInterval(() => {
                        setTimer(prev => {
                            if (prev <= 1) {
                                clearInterval(interval);
                                handleGameOver(false, ["Tempo esgotado!"]);
                                return 0;
                            }
                            return prev - 1;
                        });
                    }, 1000);
                } else {
                    setTimer(20); // Reset visual
                }
                return () => clearInterval(interval);
            }, [gameState]); // Depend apenas de gameState agora para limpar corretamente
            
            React.useEffect(() => {
                if (gameState === "PLAYING" && selectedRecipe) {
                    const activePhases = getCurrentPhases();
                    const phaseKey = activePhases[currentPhaseIndex].key;
                    if (phaseKey === "size") { setPhaseOptions(INGREDIENTS_DB.sizes); return; }
                    let fullList = getFullIngredientList(phaseKey);
                    let requiredIngs = [];
                    if (selectedRecipe.category === "SMOOTHIE") { requiredIngs = selectedRecipe[phaseKey]; } else { const sizeToUse = selectedSize || "Regular"; if (selectedRecipe.variants && selectedRecipe.variants[sizeToUse]) { requiredIngs = selectedRecipe.variants[sizeToUse][phaseKey]; } else { requiredIngs = []; } }
                    const requiredSet = new Set(requiredIngs); const requiredUnique = [...requiredSet]; const distractors = fullList.filter(ing => !requiredSet.has(ing)); const shuffledDistractors = shuffleArray([...distractors]); const slotsNeeded = Math.max(0, 9 - requiredUnique.length); const selectedDistractors = shuffledDistractors.slice(0, slotsNeeded); const finalOptions = shuffleArray([...requiredUnique, ...selectedDistractors]);
                    setPhaseOptions(finalOptions);
                }
            }, [currentPhaseIndex, gameState, selectedRecipe, selectedSize]);

            const startGame = (recipe) => { setSelectedRecipe(recipe); setGameState("PLAYING"); if (recipe.category === "GREEN") { setSelectedSize("Regular"); setCurrentPhaseIndex(1); } else if (recipe.category === "SMOOTHIE") { setSelectedSize(null); setCurrentPhaseIndex(0); } else { setSelectedSize(null); setCurrentPhaseIndex(0); } setCurrentSelections([]); setAllSelections({}); setTimer(20); };
            const resetToHome = () => { setGameState("HOME"); setMenuCategory(null); setSelectedRecipe(null); setSelectedSize(null); setTimer(20); };
            
            const handleSelection = (ingredient) => {
                const activePhases = getCurrentPhases(); const phaseKey = activePhases[currentPhaseIndex].key;
                if (phaseKey === "size") { setSelectedSize(ingredient); setCurrentPhaseIndex(prev => prev + 1); setTimer(20); return; }
                
                let requiredList = []; if (selectedRecipe.category === "SMOOTHIE") { requiredList = selectedRecipe[phaseKey]; } else { const sizeToUse = selectedSize || "Regular"; requiredList = selectedRecipe.variants[sizeToUse][phaseKey]; }
                const isCorrect = requiredList.includes(ingredient); playSound(isCorrect ? "happy" : "sad");
                
                // Impede selecionar mais do que o necess√°rio
                if (currentSelections.length >= requiredList.length && !requiredList.includes(ingredient)) return;

                const newSelections = [...currentSelections, ingredient]; setCurrentSelections(newSelections);
                if (newSelections.length === requiredList.length) {
                    const updatedAll = { ...allSelections, [phaseKey]: newSelections }; setAllSelections(updatedAll);
                    if (currentPhaseIndex < activePhases.length - 1) { setTimeout(() => { setCurrentPhaseIndex(prev => prev + 1); setCurrentSelections([]); setTimer(20); }, 250); } else { validateGame(updatedAll); }
                }
            };

            const handleUndo = () => { if (currentSelections.length > 0) { const newSel = [...currentSelections]; newSel.pop(); setCurrentSelections(newSel); } };
            const validateGame = (finalSelections) => { let errors = []; const activePhases = getCurrentPhases(); const phasesToValidate = activePhases.filter(p => p.key !== "size"); phasesToValidate.forEach(phase => { let required = []; if (selectedRecipe.category === "SMOOTHIE") { required = selectedRecipe[phase.key]; } else { const sizeToUse = selectedSize || "Regular"; required = selectedRecipe.variants[sizeToUse][phase.key]; } const requiredSorted = [...required].sort(); const selectedSorted = [...finalSelections[phase.key]].sort(); if (JSON.stringify(requiredSorted) !== JSON.stringify(selectedSorted)) { errors.push(`Erro em ${phase.title}: Era ${requiredSorted.join(", ")}`); } }); handleGameOver(errors.length === 0, errors); };
            const handleGameOver = (success, errors) => { if (success) { setGameState("RESULT_SUCCESS"); playSound("happy"); confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#E91E63', '#2196F3'] }); setResultMessage(SUCCESS_MESSAGES[Math.floor(Math.random() * SUCCESS_MESSAGES.length)]); } else { setErrorDetails(errors); setGameState("RESULT_FAIL"); playSound("sad"); setResultMessage(FAIL_MESSAGES[Math.floor(Math.random() * FAIL_MESSAGES.length)]); } };

            // MODO CUSTOM
            const initCustomGame = () => { const isFemale = Math.random() > 0.5; const nameList = isFemale ? PA_NAMES.FEMALE : PA_NAMES.MALE; const emojiList = isFemale ? PA_EMOJIS.FEMALE : PA_EMOJIS.MALE; setPaPersona({ name: nameList[Math.floor(Math.random() * nameList.length)], emoji: emojiList[Math.floor(Math.random() * emojiList.length)] }); setGameState("CUSTOM_BOWL"); setCustomPhase(1); setAllSelections({}); setCurrentSelections([]); };
            const handleCustomSize = (size) => { setAllSelections(prev => ({...prev, size: size})); setCustomPhase(4); setCurrentSelections([]); };
            const handleCustomNext = () => { if (customPhase === 1) setCustomPhase(2); else if (customPhase === 4) setCustomPhase(5); else if (customPhase === 5) setCustomPhase(6); else if (customPhase === 6) setCustomPhase(7); else if (customPhase === 7) setCustomPhase(8); else if (customPhase === 8) setCustomPhase(9); setCurrentSelections([]); };
            
            // CORRE√á√ÉO: BOT√ÉO VOLTAR CUSTOM
            const handleCustomBack = () => {
                if (currentSelections.length > 0) { setCurrentSelections(prev => prev.slice(0, -1)); return; }
                if (customPhase === 1) setGameState("HOME");
                else if (customPhase === 2) setCustomPhase(1);
                else if (customPhase === 3) setCustomPhase(2);
                else if (customPhase === 4) setCustomPhase(3); // Volta para escolha de tamanho
                else if (customPhase === 5) setCustomPhase(4);
                else if (customPhase === 6) setCustomPhase(5);
                else if (customPhase === 7) setCustomPhase(6);
                else if (customPhase === 8) setCustomPhase(7);
                else if (customPhase === 9) setCustomPhase(8);
                else if (customPhase === 10) setCustomPhase(9);
            };

            const handleCustomSelection = (item, type) => {
                const popupTrigger = (msg) => setShowPopup({ msg, callback: () => { setShowPopup(null); addCustomItem(item, type); } });
                if (type === 'base' && item === "Espinafres") return popupTrigger("Posso colocar um pouco de Azeite, se quiseres?");
                if (type === 'base' && item === "Winter Salad") return popupTrigger("Posso colocar um pouco de Vinagrete, se quiseres?");
                if (type === 'green' && (item === "Abacate" || item === "Manga" || item === "Wakame" || item === "Philadelphia")) { const price = item === "Abacate" ? "0,50‚Ç¨" : "0,30‚Ç¨"; return popupTrigger(`Este item √© premium, tem um valor adicional de ${price}.`); }
                if (type === 'protein' && (item === "Salm√£o Braseado" || item === "Fil√© de Salm√£o")) return popupTrigger("Esta prote√≠na tem um adicional de 0,50‚Ç¨.");
                if (type === 'sauce' && item === "Creme de Abacate") return popupTrigger("Este molho tem um adicional de 0,30‚Ç¨.");
                addCustomItem(item, type);
            };
            const addCustomItem = (item, type) => {
                let limit = 99; const size = allSelections['size'] || "Regular";
                if (type === 'base') limit = 2; if (type === 'green') limit = size === "Large" ? 5 : 4; if (type === 'protein') limit = size === "Large" ? 3 : 2; if (type === 'sauce') limit = 1; if (type === 'crispy') limit = 2;
                if (currentSelections.length < limit || (type === 'sauce' && currentSelections.length < 1)) { if (type === 'sauce') setCurrentSelections([item]); else setCurrentSelections(prev => [...prev, item]); playSound("happy"); }
            };
            
            const renderCustomBowl = () => {
                const size = allSelections['size'] || "Regular";
                switch(customPhase) {
                    case 1: return ( <div className="flex flex-col items-center justify-center h-full p-6 text-center space-y-8 animate-fade-in"><div className="text-6xl mb-4">{paPersona.emoji}</div><MessageBubble text={`Ol√°! Me chamo ${paPersona.name}. J√° conhece a Poke House? Vou ajudar-te a escolher a bowl perfeita. Queres criar a tua?`} /><button onClick={handleCustomNext} className="bg-brand-pink text-white px-8 py-3 rounded-win font-bold text-lg shadow-fluent hover:bg-pink-600 transition-all btn-transition">Vamos l√°!</button></div> );
                    case 2: return ( <div className="flex flex-col items-center justify-center h-full p-6 text-center space-y-8 animate-fade-in"><MessageBubble text="Para comer aqui ou para levar?" /><div className="flex gap-4"><button onClick={() => setCustomPhase(3)} className="bg-white border border-brand-blue text-brand-blue px-8 py-4 rounded-win font-bold text-xl shadow-sm hover:bg-blue-50 btn-transition">AQUI</button><button onClick={() => setShowPopup({ msg: "A caixa para levar tem custo de 0,20‚Ç¨, ok?", callback: () => { setShowPopup(null); setCustomPhase(3); } })} className="bg-white border border-brand-pink text-brand-pink px-8 py-4 rounded-win font-bold text-xl shadow-sm hover:bg-pink-50 btn-transition">LEVAR</button></div></div> );
                    case 3: return ( <div className="flex flex-col items-center justify-center h-full p-6 text-center space-y-8 animate-fade-in"><MessageBubble text="Qual tamanho prefere?" /><div className="flex gap-4"><button onClick={() => handleCustomSize("Large")} className="bg-brand-blue text-white px-8 py-6 rounded-win font-bold text-2xl shadow-fluent hover:bg-blue-600 hover:scale-105 btn-transition">LARGE</button><button onClick={() => handleCustomSize("Regular")} className="bg-brand-green text-white px-8 py-6 rounded-win font-bold text-2xl shadow-fluent hover:bg-green-600 hover:scale-105 btn-transition">REGULAR</button></div></div> );
                    case 4: return ( <div className="flex flex-col h-full p-4 animate-fade-in"><div className="mb-4"><MessageBubble text="Escolha at√© 2 bases:" /></div><div className="flex-1 overflow-y-auto grid grid-cols-2 gap-3 pb-20">{INGREDIENTS_DB.bases.map(ing => (<button key={ing} onClick={() => handleCustomSelection(ing, 'base')} className={`p-4 rounded-win shadow-sm font-medium border text-left btn-transition ${currentSelections.includes(ing) ? 'bg-blue-50 border-brand-blue text-brand-blue' : 'bg-white border-surface-border text-gray-700 hover:border-brand-blue'}`}>{ing}</button>))}</div></div> );
                    case 5: { const limit = size === "Large" ? 5 : 4; return ( <div className="flex flex-col h-full p-4 animate-fade-in"><div className="mb-4"><MessageBubble text={`Escolha ${limit} greens:`} /></div><div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 pb-20">{INGREDIENTS_DB.greens.map(ing => (<button key={ing} onClick={() => handleCustomSelection(ing, 'green')} className={`p-3 rounded-win shadow-sm text-sm font-medium border text-left btn-transition ${currentSelections.includes(ing) ? 'bg-blue-50 border-brand-blue text-brand-blue' : 'bg-white border-surface-border text-gray-700 hover:border-brand-blue'}`}>{ing}</button>))}</div></div> ); }
                    case 6: { const limit = size === "Large" ? 3 : 2; const proteins = INGREDIENTS_DB.proteins.filter(p => p !== "Wakame"); return ( <div className="flex flex-col h-full p-4 animate-fade-in"><div className="mb-4"><MessageBubble text={`Escolha ${limit} prote√≠nas:`} /></div><div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 pb-20">{proteins.map(ing => (<button key={ing} onClick={() => handleCustomSelection(ing, 'protein')} className={`p-4 rounded-win shadow-sm font-medium border text-left btn-transition ${currentSelections.includes(ing) ? 'bg-blue-50 border-brand-blue text-brand-blue' : 'bg-white border-surface-border text-gray-700 hover:border-brand-blue'}`}>{ing}</button>))}</div></div> ); }
                    case 7: return ( <div className="flex flex-col h-full p-4 animate-fade-in"><div className="mb-4"><MessageBubble text="Escolha 1 molho:" /></div><div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 pb-20">{INGREDIENTS_DB.sauces_final.map(ing => (<button key={ing} onClick={() => handleCustomSelection(ing, 'sauce')} className={`p-4 rounded-win shadow-sm font-medium border text-left btn-transition ${currentSelections.includes(ing) ? 'bg-blue-50 border-brand-blue text-brand-blue' : 'bg-white border-surface-border text-gray-700 hover:border-brand-blue'}`}>{ing}</button>))}</div></div> );
                    case 8: return ( <div className="flex flex-col h-full p-4 animate-fade-in"><div className="mb-4"><MessageBubble text="Escolha 2 crispys:" /></div><div className="flex-1 overflow-y-auto custom-scroll grid grid-cols-2 gap-3 pb-20">{INGREDIENTS_DB.crispies.map(ing => (<button key={ing} onClick={() => handleCustomSelection(ing, 'crispy')} className={`p-4 rounded-win shadow-sm font-medium border text-left btn-transition ${currentSelections.includes(ing) ? 'bg-blue-50 border-brand-blue text-brand-blue' : 'bg-white border-surface-border text-gray-700 hover:border-brand-blue'}`}>{ing}</button>))}</div></div> );
                    case 9: return ( <div className="flex flex-col items-center justify-center h-full p-6 text-center space-y-8 animate-fade-in"><MessageBubble text="Aceita s√©samo de oferta?" /><div className="flex gap-4"><button onClick={() => setCustomPhase(10)} className="bg-brand-blue text-white px-10 py-4 rounded-win font-bold text-xl shadow-fluent hover:bg-blue-600 btn-transition">Sim</button><button onClick={() => setCustomPhase(10)} className="bg-white border border-gray-300 text-gray-600 px-10 py-4 rounded-win font-bold text-xl shadow-sm hover:bg-gray-50 btn-transition">N√£o</button></div></div> );
                    case 10: const finalPhrase = FINAL_CUSTOM_PHRASES[Math.floor(Math.random() * FINAL_CUSTOM_PHRASES.length)]; return ( <div className="flex flex-col items-center justify-center h-full p-6 text-center space-y-8 animate-slide-up"><div className="text-6xl">üéâ</div><h2 className="text-3xl font-bold text-brand-blue">{finalPhrase}</h2><button onClick={resetToHome} className="bg-brand-pink text-white px-8 py-3 rounded-win font-bold shadow-fluent hover:bg-pink-600 transition-all flex items-center gap-2"><IconHome /> Voltar ao In√≠cio</button></div> );
                    default: return null;
                }
            };

            return (
                <div className="fixed inset-0 w-full h-full font-sans text-brand-dark flex flex-col md:flex-row overflow-hidden">
                    <div className="win11-bg"></div>
                    <FoodRain trigger={easterEggTrigger} quantity={3} />
                    {showPopup && <PopupModal message={showPopup.msg} onConfirm={showPopup.callback} />}

                    {/* MENU LATERAL */}
                    <div className={`p-6 md:w-80 flex flex-col gap-4 z-10 glass-panel shadow-fluent border-r border-white/50 ${gameState === "HOME" ? "w-full h-full overflow-y-auto" : (gameState === "CUSTOM_BOWL" ? "hidden" : "hidden md:flex h-full overflow-y-auto")}`}>
                        <div className="mb-4 flex justify-center md:justify-start">
                            <img src="https://storage.googleapis.com/ikona-bucket-production/images/5db193be3ea71a0001bb09f7/EXTENDED%20VERSION_original%20colors-617ac363073e550017b9966b.png" alt="Poke House" className="h-12 md:h-14 object-contain" />
                        </div>
                        
                        {gameState === "HOME" && menuCategory === null && ( 
                            <> 
                                <button onClick={initCustomGame} className="mb-2 bg-gradient-to-r from-brand-pink to-pink-500 text-white p-4 rounded-win shadow-fluent hover:shadow-fluent-hover transition-all font-bold text-lg flex items-center justify-center gap-2 transform hover:scale-[1.02]">‚ú® Criar Bowl</button> 
                                <div onClick={handleEasterEggClick} className="md:hidden text-4xl text-center py-4 cursor-pointer opacity-50 select-none">ü•ó</div> 
                            </> 
                        )}

                        {menuCategory === null && gameState === "HOME" ? ( 
                            <div className="flex flex-col gap-3 mt-2 h-full justify-center md:justify-start">
                                <button onClick={() => setMenuCategory("HOUSE")} className="bg-white border border-brand-blue text-brand-blue p-5 rounded-win shadow-sm hover:bg-blue-50 transition-all font-semibold text-lg flex items-center gap-3"><span className="text-2xl">üêü</span> House Bowls</button>
                                <button onClick={() => setMenuCategory("GREEN")} className="bg-white border border-brand-green text-brand-green p-5 rounded-win shadow-sm hover:bg-green-50 transition-all font-semibold text-lg flex items-center gap-3"><span className="text-2xl">ü•ó</span> Green Bowls</button>
                                <button onClick={() => setMenuCategory("SMOOTHIE")} className="bg-white border border-brand-yellow text-yellow-600 p-5 rounded-win shadow-sm hover:bg-yellow-50 transition-all font-semibold text-lg flex items-center gap-3"><span className="text-2xl">ü•§</span> Smoothies</button>
                            </div> 
                        ) : gameState !== "CUSTOM_BOWL" && ( 
                            <div className="flex flex-col gap-2 animate-fade-in">
                                <button onClick={() => setMenuCategory(null)} className="mb-2 text-gray-500 font-medium flex items-center gap-2 hover:text-brand-blue px-2 py-1"><IconArrowLeft size={18}/> Voltar</button>
                                <h3 className="font-bold text-gray-400 text-xs uppercase tracking-wider mb-2">{menuCategory} MENU</h3>
                                {RECIPES.filter(r => r.category === menuCategory).map(recipe => ( 
                                    <button key={recipe.id} onClick={() => startGame(recipe)} disabled={gameState === "PLAYING" && selectedRecipe?.id !== recipe.id} 
                                        className={`p-3 rounded-win text-left font-medium text-sm transition-all border ${selectedRecipe?.id === recipe.id ? "bg-brand-blue text-white border-brand-blue shadow-md" : "bg-white text-gray-700 border-transparent hover:bg-gray-50"} ${gameState === "PLAYING" && selectedRecipe?.id !== recipe.id ? "opacity-40 hidden md:block" : ""}`}>
                                        {recipe.name}
                                    </button> 
                                ))}
                            </div> 
                        )}
                    </div>

                    {/* √ÅREA DO JOGO */}
                    <div className={`flex-1 relative z-10 flex flex-col items-center justify-center p-4 ${gameState === "HOME" ? "hidden md:flex" : "flex h-full"}`}>
                        {gameState === "CUSTOM_BOWL" && ( 
                            <div className="w-full h-full glass-panel rounded-win shadow-fluent flex flex-col overflow-hidden relative">
                                <div className="flex-1 overflow-hidden relative">{renderCustomBowl()}</div>
                                {customPhase >= 4 && customPhase < 9 && ( 
                                    <div className="h-20 bg-white/80 backdrop-blur border-t border-surface-border flex items-center justify-between px-6 shrink-0 z-20">
                                        <button onClick={handleCustomBack} className="bg-gray-100 p-3 rounded-full text-gray-600 hover:bg-gray-200 transition-colors"><IconArrowLeft size={24}/></button>
                                        <div className="flex gap-2">
                                            <button onClick={resetToHome} className="bg-gray-100 p-3 rounded-full text-gray-600 hover:bg-gray-200 transition-colors"><IconHome size={24}/></button>
                                            <button onClick={handleCustomNext} className="bg-brand-blue p-3 rounded-full text-white shadow-lg hover:bg-blue-600 transition-transform active:scale-95"><IconArrowRight size={24}/></button>
                                        </div>
                                    </div> 
                                )}
                            </div> 
                        )}
                        
                        {gameState === "PLAYING" && ( 
                            <div className="w-full h-full md:h-auto md:max-h-[90vh] max-w-5xl glass-panel rounded-win shadow-fluent flex flex-col overflow-hidden animate-slide-up">
                                <div className="p-3 bg-white/50 border-b border-surface-border text-center text-gray-500 text-sm font-medium">
                                    {selectedRecipe.name} {selectedSize && `‚Ä¢ ${selectedSize}`}
                                </div>
                                <div className="flex justify-between items-center p-6 border-b border-surface-border bg-white/30">
                                    <div>
                                        <h2 className="text-2xl font-bold text-brand-dark">{getCurrentPhaseData().title}</h2>
                                        <p className="text-sm text-gray-500 mt-1">{getSelectionLimit() > 1 ? `Selecione ${getSelectionLimit()} op√ß√µes.` : "Selecione a op√ß√£o correta."}</p>
                                    </div>
                                    <div className="flex flex-col items-center bg-white px-4 py-2 rounded-win shadow-sm border border-gray-100">
                                        <span className={`text-2xl font-bold font-mono ${timer <= 5 ? 'text-red-500' : 'text-brand-blue'}`}>00:{timer < 10 ? `0${timer}` : timer}</span>
                                    </div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-4 md:p-8 custom-scroll bg-white/20">
                                    <div className={`grid gap-3 w-full ${phaseOptions.length > 6 ? 'grid-cols-2 md:grid-cols-4' : 'grid-cols-2 md:grid-cols-3'}`}>
                                        {phaseOptions.map((ing, idx) => { 
                                            const count = currentSelections.filter(i => i === ing).length; 
                                            return (
                                                <button key={idx} onClick={() => handleSelection(ing)} 
                                                    className={`relative p-4 rounded-win font-semibold text-sm transition-all flex items-center justify-center text-center h-24 shadow-sm border btn-transition 
                                                    ${count > 0 ? 'bg-blue-50 border-brand-blue text-brand-blue ring-2 ring-brand-blue/20' : 'bg-white border-surface-border text-gray-700 hover:border-brand-blue hover:shadow-md'}`}>
                                                    {ing}
                                                    {count > 0 && <span className="absolute -top-2 -right-2 bg-brand-blue text-white text-xs w-6 h-6 flex items-center justify-center rounded-full shadow-sm">{count}</span>}
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>
                                <div className="p-4 border-t border-surface-border bg-gray-50 flex justify-between">
                                    <button onClick={resetToHome} className="flex items-center gap-2 text-gray-500 hover:text-brand-dark px-3 py-2 text-sm font-medium"><IconHome size={18}/> Cancelar</button>
                                    <button onClick={handleUndo} disabled={currentSelections.length === 0} className="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-win text-gray-700 hover:bg-gray-100 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm text-sm font-medium"><IconArrowLeft size={18}/> Desfazer</button>
                                </div>
                            </div> 
                        )}

                        {gameState === "RESULT_SUCCESS" && ( 
                            <div className="text-center p-12 glass-panel rounded-win shadow-fluent animate-slide-up mx-4 max-w-md w-full border-t-4 border-brand-green">
                                <div className="inline-flex items-center justify-center w-16 h-16 rounded-full bg-green-100 text-brand-green mb-6"><IconCheck size={32} /></div>
                                <h2 className="text-3xl font-bold text-gray-800 mb-2">Excelente!</h2>
                                <p className="text-gray-600 mb-8">{resultMessage}</p>
                                <button onClick={resetToHome} className="w-full bg-brand-dark text-white px-6 py-3 rounded-win font-semibold hover:bg-gray-800 transition-colors shadow-lg">Menu Principal</button>
                            </div> 
                        )}

                        {gameState === "RESULT_FAIL" && ( 
                            <div className="text-center p-10 glass-panel rounded-win shadow-fluent animate-slide-up mx-4 max-w-md w-full border-t-4 border-brand-pink">
                                <div className="text-5xl mb-4">üòï</div>
                                <h2 className="text-2xl font-bold text-gray-800 mb-2">Ops!</h2>
                                <p className="text-gray-600 mb-6">{resultMessage}</p>
                                <div className="bg-red-50 p-4 rounded-win text-left text-sm text-red-600 mb-8 border border-red-100 max-h-40 overflow-y-auto custom-scroll">
                                    {errorDetails.map((e, i) => <div key={i} className="mb-1 pb-1 border-b border-red-100 last:border-0">‚Ä¢ {e}</div>)}
                                </div>
                                <button onClick={resetToHome} className="w-full bg-brand-dark text-white px-6 py-3 rounded-win font-semibold hover:bg-gray-800 transition-colors shadow-lg flex items-center justify-center gap-2"><IconRotate size={18} /> Tentar Novamente</button>
                            </div> 
                        )}

                        {gameState === "HOME" && ( 
                            <div className="hidden md:flex flex-col items-center justify-center text-center p-12 max-w-lg">
                                <div className="w-24 h-24 bg-white rounded-full flex items-center justify-center shadow-fluent mb-6">
                                    <span className="text-4xl">ü•ó</span>
                                </div>
                                <h1 className="text-brand-dark font-bold text-3xl mb-2">Treino Poke House</h1>
                                <p className="text-gray-500">Selecione uma categoria no menu √† esquerda para come√ßar o seu treinamento ou crie uma bowl personalizada.</p>
                            </div> 
                        )}
                    </div>
                    
                    <div className="fixed bottom-4 right-4 z-50">
                        <button onClick={() => setShowChangelog(true)} className="text-xs text-gray-400 font-sans hover:text-brand-blue transition-colors bg-white/80 px-2 py-1 rounded border border-gray-200">v4.05</button>
                    </div>
                    {showChangelog && <ChangelogModal onClose={() => setShowChangelog(false)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
