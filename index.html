<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Poke House ‚Äì Monte a Bowl v1.16</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'pastel-pink': { 100: '#FFE6F2', 200: '#FFC8DD', 300: '#FFAFCC', 400: '#FF99C8', 500: '#FF70A6' },
                        'pastel-blue': { 100: '#E0F2FF', 200: '#BDE0FE', 300: '#A0C4FF', 400: '#80A8FF', 500: '#404FC2' },
                        'pastel-green': '#A7F3D0',
                    },
                    animation: {
                        'bounce-in': 'bounceIn 0.8s cubic-bezier(0.215, 0.610, 0.355, 1.000) both',
                        'shake': 'shake 0.8s cubic-bezier(.36,.07,.19,.97) both',
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                    },
                    keyframes: {
                        bounceIn: {
                            '0%': { opacity: '0', transform: 'scale3d(0.3, 0.3, 0.3)' },
                            '20%': { transform: 'scale3d(1.1, 1.1, 1.1)' },
                            '40%': { transform: 'scale3d(0.9, 0.9, 0.9)' },
                            '60%': { opacity: '1', transform: 'scale3d(1.03, 1.03, 1.03)' },
                            '80%': { transform: 'scale3d(0.97, 0.97, 0.97)' },
                            '100%': { opacity: '1', transform: 'scale3d(1, 1, 1)' }
                        },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        /* Fundo base */
        body { margin: 0; overflow: hidden; background-color: #FFE6F2; touch-action: manipulation; }
        .backdrop-blur-md { backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: rgba(0,0,0,0.05); border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #A0C4FF; border-radius: 4px; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- √çCONES ---
        const IconHome = ({ size = 20, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        );
        const IconArrowLeft = ({ size = 20, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
        );
        const IconRotate = ({ size = 20, color = "currentColor" }) => (
             <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
        );
        const IconTrophy = ({ size = 24, color = "currentColor" }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>
        );

        // --- DADOS ATUALIZADOS ---
        const INGREDIENTS_DB = {
            bases: ["Arroz de sushi", "Arroz preto", "Quinoa", "Arroz basmati", "Coconut Basmati", "Espinafres", "Winter Salad"],
            sauces_base: ["Azeite", "Azeite de Lim√£o", "Vinagrete", "Ponzu", "Sriracha Mayo", "N√£o leva"],
            greens: [
                "Batata Doce com Alecrim", "Br√≥colis", "Pickle Cebola", "Beterraba", "Cenoura c/ Soja", "Milho", "Abacaxi",
                "Edamame", "Tomate Cherry", "Couve roxa", "Courgette", "Cenoura", "Grana Padano", "Pepino", "Feta",
                "Jalape√±os", "Azeitonas", "Abacate", "Philadelphia", "Wakame", "Manga", "Hummus", 
                "Hortel√£ (Fresca)"
            ],
            proteins: [
                "Salm√£o Braseado", "Fil√© de Salm√£o", "Frango Vietnamita", "Camar√£o Panado", "Frango", "Frango Teriyaki",
                "Camar√£o", "Juicy Salmon", "Juicy Tuna", "Salm√£o", "Atum", "Tofu Grelhado", "Ovo", "N√£o leva"
            ],
            sauces_final: [
                "Creamy Caesar", "Creme de Abacate", "Spicy Peanuts", "Mel", "Chipotle", "S√©samo Shoyu", "Sriracha Mayo",
                "Wasabi Mayo", "Azeite", "Azeite de Lim√£o", "Manjeric√£o e Hortel√£", "Vinagrete", "Soja", "Teriyaki",
                "Ponzu", "Especial"
            ],
            crispies: [
                "Cebola frita", "Ervilhas Wasabi", "Algas Nori", "Am√™ndoa", "Batata Doce", "Lima", "Bacon", "Croutons",
                "Batata Doce Crocante", "N√£o leva", "Cebola Crocante"
            ],
            sesame: ["Sim", "N√£o"]
        };

        const RECIPES = [
            // HOUSE BOWLS
            { id: 1, category: "HOUSE", name: "Sunny Salmon üåû", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Couve roxa", "Edamame"], protein: ["Juicy Salmon", "Juicy Salmon"], sauce_final: ["Especial", "Creme de Abacate"], crispy: ["N√£o leva"], sesame: ["Sim"] },
            { id: 2, category: "HOUSE", name: "Spicy Tuna üêü", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Couve roxa", "Pepino", "Cenoura"], protein: ["Atum", "Atum"], sauce_final: ["Ponzu", "Spicy Peanuts"], crispy: ["Cebola frita"], sesame: ["Sim"] },
            { id: 3, category: "HOUSE", name: "Vegetarian üåø", base: ["Arroz basmati", "Arroz basmati"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Hummus", "Hummus", "Tomate Cherry", "Pepino", "Azeitonas"], protein: ["N√£o leva"], sauce_final: ["Manjeric√£o e Hortel√£"], crispy: ["Batata Doce Crocante"], sesame: ["Sim"] },
            { id: 4, category: "HOUSE", name: "Chicken üêî", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Couve roxa", "Tomate Cherry", "Courgette"], protein: ["Frango Teriyaki", "Frango Teriyaki"], sauce_final: ["Teriyaki", "Sriracha Mayo"], crispy: ["Am√™ndoa"], sesame: ["Sim"] },
            { id: 5, category: "HOUSE", name: "Fire Salmon üî•", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["Sriracha Mayo"], greens: ["Jalape√±os", "Tomate Cherry", "Pepino"], protein: ["Salm√£o", "Salm√£o"], sauce_final: ["Sriracha Mayo"], crispy: ["Cebola frita"], sesame: ["Sim"] },
            { id: 6, category: "HOUSE", name: "Mixed Seas üåä", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Manga", "Wakame", "Cenoura", "Pickle Cebola"], protein: ["Atum", "Salm√£o"], sauce_final: ["Ponzu"], crispy: ["Ervilhas Wasabi"], sesame: ["Sim"] },
            { id: 7, category: "HOUSE", name: "Crispy Shrimp ü¶ê", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Philadelphia", "Manga", "Pepino"], protein: Array(8).fill("Camar√£o Panado"), sauce_final: ["Teriyaki", "Sriracha Mayo"], crispy: ["Algas Nori"], sesame: ["Sim"] },
            { id: 8, category: "HOUSE", name: "Salmon Sushi üç£", base: ["Arroz de sushi", "Arroz de sushi"], sauce_base: ["N√£o leva"], greens: ["Abacate", "Philadelphia", "Edamame"], protein: ["Salm√£o Braseado", "Salm√£o Braseado"], sauce_final: ["Teriyaki"], crispy: ["Cebola Crocante"], sesame: ["Sim"] },
            
            // GREEN BOWLS
            { id: 9, category: "GREEN", name: "The Caesar ü•ó", base: ["Winter Salad", "Winter Salad", "Winter Salad"], sauce_base: ["Vinagrete"], greens: ["Tomate Cherry", "Tomate Cherry", "Grana Padano"], protein: ["Frango", "Frango", "Frango"], sauce_final: ["Creamy Caesar"], crispy: ["Bacon", "Croutons", "Lima"], sesame: ["N√£o"] },
            { id: 10, category: "GREEN", name: "Exotic Salmon ü•ó", base: ["Coconut Basmati", "Espinafres", "Espinafres", "Espinafres"], sauce_base: ["Azeite de Lim√£o"], greens: ["Batata Doce com Alecrim", "Batata Doce com Alecrim", "Br√≥colis", "Abacate"], protein: ["Fil√© de Salm√£o", "Fil√© de Salm√£o", "Fil√© de Salm√£o"], sauce_final: ["Sriracha Mayo"], crispy: ["N√£o leva"], sesame: ["N√£o"] },
            { id: 11, category: "GREEN", name: "Velvet Garden ü•ó", base: ["Winter Salad", "Winter Salad", "Winter Salad"], sauce_base: ["Vinagrete"], greens: ["Cenoura c/Soja", "Beterraba", "Azeitonas", "Pickle Cebola", "Feta", "Feta", "Feta"], protein: ["N√£o leva"], sauce_final: ["Manjeric√£o e Hortel√£"], crispy: ["N√£o leva"], sesame: ["N√£o"] },
            { id: 12, category: "GREEN", name: "Cozy Chicken ü•ó", base: ["Coconut Basmati", "Espinafres", "Espinafres"], sauce_base: ["Azeite de Lim√£o"], greens: ["Br√≥colis", "Batata Doce com Alecrim", "Couve roxa", "Courgette"], protein: ["Frango Vietnamita", "Frango Vietnamita", "Frango Vietnamita"], sauce_final: ["Soja"], crispy: ["N√£o leva"], sesame: ["N√£o"] }
        ];

        const PHASES = [
            { key: "base", title: "1Ô∏è‚É£ ‚Äì Base:", hint: "Escolha as bases." },
            { key: "sauce_base", title: "2Ô∏è‚É£ ‚Äì Molho da base:", hint: "Escolha o molho." },
            { key: "greens", title: "3Ô∏è‚É£ ‚Äì Greens:", hint: "Escolha os greens." },
            { key: "protein", title: "4Ô∏è‚É£ ‚Äì Prote√≠na:", hint: "Escolha as prote√≠nas." },
            { key: "sauce_final", title: "5Ô∏è‚É£ ‚Äì Molho final:", hint: "Escolha os molhos." },
            { key: "crispy", title: "6Ô∏è‚É£ ‚Äì Crispy:", hint: "Escolha UM crispy." }, 
            { key: "sesame", title: "7Ô∏è‚É£ ‚Äì S√©samo:", hint: "Essa Bowl leva s√©samo?" },
        ];

        // --- L√ìGICA DE SOM ---
        const playSound = (type) => {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!AudioContext) return;
            const ctx = new AudioContext();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain);
            gain.connect(ctx.destination);
            
            const now = ctx.currentTime;
            if (type === "happy") {
                osc.type = "sine";
                osc.frequency.setValueAtTime(600, now);
                osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                osc.start(); osc.stop(now + 0.1);
            } else {
                osc.type = "sawtooth";
                osc.frequency.setValueAtTime(300, now);
                osc.frequency.linearRampToValueAtTime(150, now + 0.3);
                gain.gain.setValueAtTime(0.1, now);
                gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
                osc.start(); osc.stop(now + 0.3);
            }
        };

        // --- UTILS ---
        function shuffleArray(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        // --- FUNDO (C√âU ROSA 60%, MAR DIVIDIDO 16%/24%, SURFISTAS ZIGZAG LENTO) ---
        const OceanBackground = ({ active }) => {
            const canvasRef = React.useRef(null);
            
            React.useEffect(() => {
                if (!active) return;
                const canvas = canvasRef.current;
                if (!canvas) return;
                const ctx = canvas.getContext("2d");
                
                const skyHeightRatio = 0.60;
                const seaTopHeightRatio = 0.16; 
                const skyColor = "#FFE6F2";

                const seaLayers = [
                    { name: "Mar 2 (Topo)", color: "#A0C4FF", startYRatio: skyHeightRatio, endYRatio: skyHeightRatio + seaTopHeightRatio, wave: { amplitude: 5, wavelength: 90, speed: 0.3 } },
                    { name: "Mar 1 (Fundo)", color: "#80A8FF", startYRatio: skyHeightRatio + seaTopHeightRatio, endYRatio: 1.0, wave: { amplitude: 8, wavelength: 120, speed: 0.2 } }
                ];
                
                let surfers = []; 
                const SURFER_EMOJIS = ['üèÑ‚Äç‚ôÇÔ∏è', 'üèÑ‚Äç‚ôÄÔ∏è'];

                const createSurfer = () => {
                    const startSide = Math.random() > 0.5 ? 'LEFT' : 'RIGHT';
                    const horizonY = canvas.height * skyHeightRatio;
                    const minY = horizonY + 50;
                    const maxY = canvas.height - 50;
                    const spawnY = minY + Math.random() * (maxY - minY);
                    const sizeScale = 0.7 + Math.random() * 0.6;

                    return { 
                        x: startSide === 'LEFT' ? -150 : canvas.width + 150, 
                        y: spawnY,
                        // Velocidade bem mais lenta
                        speedX: (startSide === 'LEFT' ? 1 : -1) * (0.4 + Math.random() * 0.4), 
                        // Dire√ß√£o vertical inicial (1 = desce, -1 = sobe)
                        verticalDir: Math.random() > 0.5 ? 1 : -1,
                        // Velocidade vertical relativa
                        verticalSpeedFactor: 0.3 + Math.random() * 0.3,
                        // Timer para mudar o zigzag
                        zigzagTimer: 0,
                        zigzagInterval: 150 + Math.floor(Math.random() * 150),
                        sprite: SURFER_EMOJIS[Math.floor(Math.random() * SURFER_EMOJIS.length)],
                        sizeScale: sizeScale,
                        active: true,
                        trail: [] 
                    };
                };

                const resize = () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; };
                window.addEventListener("resize", resize); resize();

                let animationFrameId;
                let time = 0;
                const loop = () => {
                    time += 0.01;
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    const h = canvas.height;
                    const horizonY = h * skyHeightRatio;
                    const seaBottomY = h;

                    // 1. C√©u
                    ctx.fillStyle = skyColor; 
                    ctx.fillRect(0, 0, canvas.width, horizonY + 10); 

                    // 2. Mar
                    seaLayers.forEach(layer => {
                        const startY = h * layer.startYRatio;
                        const endY = h * layer.endYRatio;
                        ctx.fillStyle = layer.color;
                        ctx.beginPath();
                        ctx.moveTo(0, endY);
                        for (let x = 0; x <= canvas.width; x += 10) {
                            const waveY = startY + Math.sin(x / layer.wave.wavelength + time * layer.wave.speed) * layer.wave.amplitude;
                            ctx.lineTo(x, waveY);
                        }
                        ctx.lineTo(canvas.width, endY);
                        ctx.lineTo(0, endY);
                        ctx.fill();
                        if(layer.endYRatio === 1.0) ctx.fillRect(0, endY - 1, canvas.width, h - endY + 1);
                    });
                    
                    // 3. Surfistas
                    if (surfers.length < 2 && Math.random() < 0.005) { // Menor chance de spawn para n√£o lotar com a velocidade lenta
                        surfers.push(createSurfer());
                    }

                    surfers.forEach(f => updateSurfer(f, canvas.width, canvas.height, horizonY, seaBottomY, time));
                    surfers = surfers.filter(f => f.active);
                    surfers.forEach(f => drawSurferTrail(ctx, f));
                    surfers.forEach(f => drawSurferSprite(ctx, f));
                    
                    animationFrameId = requestAnimationFrame(loop);
                };
                animationFrameId = requestAnimationFrame(loop);
                return () => { window.removeEventListener("resize", resize); cancelAnimationFrame(animationFrameId); };
            }, [active]);

            if (!active) return null;
            return <canvas ref={canvasRef} style={{position:'fixed', top:0, left:0, width:'100%', height:'100%', zIndex:-1}} />;
        };
        
        // Nova l√≥gica de movimento Zigzag Lento com restri√ß√£o de horizonte e tremido
        function updateSurfer(f, w, h, horizonY, seaBottomY, t){ 
            f.trail.push({x: f.x, y: f.y});
            if (f.trail.length > 30) f.trail.shift(); // Rastro um pouco mais longo

            // Movimento Horizontal Constante (Lento)
            f.x += f.speedX;

            // L√≥gica Zigzag Vertical
            f.zigzagTimer++;
            
            // Calcula a pr√≥xima posi√ß√£o Y potencial
            let nextY = f.y + (f.speedX * f.verticalDir * f.verticalSpeedFactor);

            // Margem de seguran√ßa do horizonte (para n√£o tocar na onda)
            const safetyMarginTop = 40;
            // Margem do fundo
            const safetyMarginBottom = 40;

            // Verifica√ß√£o de Limites (Zigzag for√ßado)
            if (f.verticalDir === -1 && nextY < horizonY + safetyMarginTop) {
                // Se est√° subindo e vai passar do horizonte, for√ßa a descida imediatamente
                f.verticalDir = 1;
                f.zigzagTimer = 0;
            } else if (f.verticalDir === 1 && nextY > seaBottomY - safetyMarginBottom) {
                 // Se est√° descendo muito, for√ßa a subida
                f.verticalDir = -1;
                f.zigzagTimer = 0;
            } else if (f.zigzagTimer > f.zigzagInterval) {
                // Troca de dire√ß√£o normal por tempo
                f.verticalDir *= -1;
                f.zigzagTimer = 0;
            }

            // Aplica o movimento vertical
            f.y += Math.abs(f.speedX) * f.verticalDir * f.verticalSpeedFactor;

            // Adiciona o "tremido" lento (oscila√ß√£o suave)
            f.y += Math.sin(t * 2 + f.x * 0.01) * 0.5;

            // Verifica se saiu da tela pelas laterais
            if(f.x < -200 || f.x > w + 200) {
                f.active = false;
            }
        }

        function drawSurferTrail(ctx, f) {
            const trailSize = 25 * f.sizeScale; 
            f.trail.forEach((point, index) => {
                // Opacidade diminui mais lentamente
                const opacity = (index / f.trail.length) * 0.5; 
                ctx.fillStyle = `rgba(220, 245, 255, ${opacity})`; 
                ctx.fillRect(point.x + 10, point.y + 20, trailSize, trailSize * 0.6);
            });
        }

        function drawSurferSprite(ctx, f){ 
            ctx.font=`${Math.max(24,f.sizeScale*40)}px sans-serif`; 
            // Sombra suave para destacar
            ctx.shadowColor = "rgba(0,80,150,0.2)"; ctx.shadowBlur = 8; ctx.shadowOffsetY = 5;
            ctx.fillText(f.sprite,f.x,f.y); 
            ctx.shadowBlur = 0; ctx.shadowOffsetY = 0;
        }


        // --- APP ---
        function App() {
            const [gameState, setGameState] = React.useState("HOME");
            const [menuCategory, setMenuCategory] = React.useState(null); 
            const [selectedRecipe, setSelectedRecipe] = React.useState(null);
            const [currentPhaseIndex, setCurrentPhaseIndex] = React.useState(0);
            const [currentSelections, setCurrentSelections] = React.useState([]);
            const [allSelections, setAllSelections] = React.useState({});
            const [phaseOptions, setPhaseOptions] = React.useState([]);
            const [timer, setTimer] = React.useState(20);
            const [timerEmoji, setTimerEmoji] = React.useState("üòÉ");
            const [errorDetails, setErrorDetails] = React.useState([]);
            
            const [startTime, setStartTime] = React.useState(0);
            const [finalScore, setFinalScore] = React.useState(0);
            const [playerName, setPlayerName] = React.useState("");
            const [highScore, setHighScore] = React.useState({ name: "Ainda Ningu√©m", score: 0 });

            React.useEffect(() => {
                const savedScore = localStorage.getItem('pokeHighScore');
                if (savedScore) {
                    setHighScore(JSON.parse(savedScore));
                }
            }, []);

            React.useEffect(() => {
                if (gameState !== "PLAYING") return;
                if (timer > 12) setTimerEmoji("üòÉ"); else if (timer > 7) setTimerEmoji("ü§®"); else if (timer > 4) setTimerEmoji("üò¨"); else setTimerEmoji("üò±");
                if (timer === 0) { handleGameOver(false, ["Tempo esgotado!"]); return; }
                const interval = setInterval(() => setTimer(t => t - 1), 1000);
                return () => clearInterval(interval);
            }, [timer, gameState]);

            React.useEffect(() => {
                if (gameState === "PLAYING" && selectedRecipe) {
                    const phaseKey = PHASES[currentPhaseIndex].key;
                    const fullList = getFullIngredientList(phaseKey);
                    const requiredIngs = selectedRecipe[phaseKey];
                    const requiredSet = new Set(requiredIngs);
                    const requiredUnique = [...requiredSet];
                    const distractors = fullList.filter(ing => !requiredSet.has(ing));
                    const shuffledDistractors = shuffleArray([...distractors]);
                    const slotsNeeded = Math.max(0, 9 - requiredUnique.length);
                    const selectedDistractors = shuffledDistractors.slice(0, slotsNeeded);
                    const finalOptions = shuffleArray([...requiredUnique, ...selectedDistractors]);
                    setPhaseOptions(finalOptions);
                }
            }, [currentPhaseIndex, gameState, selectedRecipe]);

            const startGame = (recipe) => {
                setSelectedRecipe(recipe); 
                setGameState("PLAYING"); 
                setCurrentPhaseIndex(0); 
                setCurrentSelections([]); 
                setAllSelections({}); 
                setTimer(20);
                setStartTime(Date.now());
            };

            const resetToHome = () => {
                setGameState("HOME");
                setMenuCategory(null);
                setSelectedRecipe(null);
                setPlayerName("");
            };

            const handleSelection = (ingredient) => {
                setTimer(20);
                const phase = PHASES[currentPhaseIndex];
                const requiredList = selectedRecipe[phase.key];
                const isCorrect = requiredList.includes(ingredient);
                playSound(isCorrect ? "happy" : "sad");

                const newSelections = [...currentSelections, ingredient];
                setCurrentSelections(newSelections);

                if (newSelections.length === selectedRecipe[phase.key].length) {
                    const updatedAll = { ...allSelections, [phase.key]: newSelections };
                    setAllSelections(updatedAll);
                    if (currentPhaseIndex < PHASES.length - 1) {
                        setTimeout(() => { setCurrentPhaseIndex(prev => prev + 1); setCurrentSelections([]); setTimer(20); }, 300);
                    } else {
                        validateGame(updatedAll);
                    }
                }
            };

            const handleUndo = () => { if (currentSelections.length > 0) { const newSel = [...currentSelections]; newSel.pop(); setCurrentSelections(newSel); } };

            const validateGame = (finalSelections) => {
                let errors = [];
                PHASES.forEach(phase => {
                    const required = [...selectedRecipe[phase.key]].sort();
                    const selected = [...finalSelections[phase.key]].sort();
                    if (JSON.stringify(required) !== JSON.stringify(selected)) errors.push(`Erro em ${phase.title.replace(":", "")}. Era: ${required.join(", ")}`);
                });
                
                if (errors.length === 0) {
                    const durationSeconds = (Date.now() - startTime) / 1000;
                    const score = Math.max(0, Math.round(1000 - (durationSeconds * 5)));
                    setFinalScore(score);
                }
                
                handleGameOver(errors.length === 0, errors);
            };

            const handleGameOver = (success, errors) => {
                if (success) {
                    setGameState("RESULT_SUCCESS"); playSound("happy");
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                } else {
                    setErrorDetails(errors); setGameState("RESULT_FAIL"); playSound("sad");
                }
            };

            const saveScore = () => {
                if (!playerName.trim()) return;
                if (finalScore > highScore.score) {
                    const newRecord = { name: playerName, score: finalScore };
                    setHighScore(newRecord);
                    localStorage.setItem('pokeHighScore', JSON.stringify(newRecord));
                }
                resetToHome();
            };

            const getFullIngredientList = (key) => {
                 switch(key) {
                    case 'base': return INGREDIENTS_DB.bases;
                    case 'sauce_base': return INGREDIENTS_DB.sauces_base;
                    case 'greens': return INGREDIENTS_DB.greens;
                    case 'protein': return INGREDIENTS_DB.proteins;
                    case 'sauce_final': return INGREDIENTS_DB.sauces_final;
                    case 'crispy': return INGREDIENTS_DB.crispies;
                    case 'sesame': return INGREDIENTS_DB.sesame;
                    default: return [];
                }
            };

            return (
                <div className="fixed inset-0 w-full h-full font-sans text-slate-800 flex flex-col md:flex-row overflow-hidden">
                    <OceanBackground active={gameState !== "PLAYING"} />
                    
                    {/* MENU */}
                    <div className={`p-4 md:w-1/4 flex flex-col gap-2 transition-all duration-500 z-10 bg-pastel-blue-100/80 backdrop-blur-md border-r border-pastel-blue-200/40 shadow-lg
                        ${gameState === "HOME" ? "w-full h-full overflow-y-auto" : "hidden md:flex h-full overflow-y-auto"}
                    `}>
                        <div className="mb-6 text-center md:text-left flex justify-center md:justify-start">
                            <img src="https://storage.googleapis.com/ikona-bucket-production/images/5db193be3ea71a0001bb09f7/EXTENDED%20VERSION_original%20colors-617ac363073e550017b9966b.png" alt="Poke House Logo" className="h-12 md:h-16 object-contain" />
                        </div>
                        
                        {menuCategory === null ? (
                            <div className="flex flex-col gap-4 mt-4 md:mt-0 h-full justify-center md:justify-start">
                                {/* SCORE BOARD */}
                                <div className="bg-white/50 p-4 rounded-xl mb-4 border border-pastel-blue-300 shadow-sm text-center">
                                    <p className="text-xs text-slate-500 uppercase tracking-wide font-bold">üèÜ Recorde Atual</p>
                                    <p className="text-pastel-blue-500 font-extrabold text-xl">{highScore.score} pts</p>
                                    <p className="text-sm text-slate-700">{highScore.name}</p>
                                </div>

                                <button onClick={() => setMenuCategory("HOUSE")} className="bg-pastel-blue-400 text-white p-6 rounded-2xl shadow-lg hover:bg-pastel-blue-500 transition-all transform hover:scale-105 flex flex-col items-center">
                                    <span className="text-4xl mb-2">üêü</span>
                                    <span className="text-xl font-bold">House Bowls</span>
                                </button>
                                <button onClick={() => setMenuCategory("GREEN")} className="bg-pastel-green text-slate-800 p-6 rounded-2xl shadow-lg hover:bg-green-300 transition-all transform hover:scale-105 flex flex-col items-center">
                                    <span className="text-4xl mb-2">ü•ó</span>
                                    <span className="text-xl font-bold">Green Bowls</span>
                                </button>
                            </div>
                        ) : (
                            <div className="flex flex-col gap-2 animate-fade-in">
                                <button onClick={() => setMenuCategory(null)} className="mb-2 text-pastel-blue-500 font-bold flex items-center gap-2 hover:bg-pastel-blue-100/50 p-2 rounded-lg"><IconArrowLeft size={16} color="#404FC2"/> Voltar</button>
                                <h3 className="font-bold text-pastel-blue-500 mb-2 uppercase tracking-wide">{menuCategory} BOWLS</h3>
                                {RECIPES.filter(r => r.category === menuCategory).map(recipe => (
                                    <button key={recipe.id} onClick={() => startGame(recipe)} disabled={gameState === "PLAYING" && selectedRecipe?.id !== recipe.id} className={`p-3 rounded-xl shadow-sm text-left font-semibold transition-all ${selectedRecipe?.id === recipe.id ? "bg-pastel-blue-300 text-white scale-105" : "bg-pastel-blue-100/80 hover:bg-pastel-blue-200/80 text-slate-700"} ${gameState === "PLAYING" && selectedRecipe?.id !== recipe.id ? "opacity-50 hidden md:block" : ""}`}>
                                        {recipe.name}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* JOGO */}
                    <div className={`flex-1 relative z-10 flex flex-col items-center justify-center p-2 md:p-6 ${gameState === "HOME" ? "hidden md:flex" : "flex h-full"}`}>
                        
                        {gameState === "PLAYING" && (
                            <div className="w-full h-full md:h-auto md:max-h-[90vh] max-w-5xl bg-pastel-blue-100/85 backdrop-blur-md rounded-xl md:rounded-3xl shadow-xl border border-pastel-blue-200/50 animate-fade-in flex flex-col overflow-hidden">
                                <div className="p-2 bg-pastel-blue-200/50 text-center text-pastel-blue-500 font-semibold text-sm md:text-base border-b border-pastel-blue-200/50 shrink-0">
                                    Receita Atual: <span className="font-bold">{selectedRecipe.name}</span>
                                </div>
                                <div className="flex justify-between items-center p-4 border-b border-pastel-blue-200/50 bg-pastel-blue-100/40 shrink-0">
                                    <div>
                                        <h2 className="text-xl md:text-3xl font-bold text-pastel-blue-500">{PHASES[currentPhaseIndex].title}</h2>
                                        
                                        <p className="text-xs md:text-base text-slate-600">
                                            {selectedRecipe[PHASES[currentPhaseIndex].key].length > 1 
                                                ? `Escolha ${selectedRecipe[PHASES[currentPhaseIndex].key].length} op√ß√µes.` 
                                                : PHASES[currentPhaseIndex].hint}
                                        </p>

                                        <div className="text-xs md:text-sm mt-1 font-bold text-pastel-blue-400">Selecionado: {currentSelections.length} / {selectedRecipe[PHASES[currentPhaseIndex].key].length}</div>
                                    </div>
                                    <div className="flex flex-col items-center min-w-[60px]"><span className="text-3xl md:text-4xl">{timerEmoji}</span><span className="text-xl md:text-2xl font-bold text-pastel-blue-500">{timer}s</span></div>
                                </div>
                                <div className="flex-1 overflow-y-auto p-2 md:p-6 custom-scroll min-h-0 flex items-center justify-center">
                                    <div className={`grid gap-2 md:gap-4 w-full ${phaseOptions.length > 6 ? 'grid-cols-3 md:grid-cols-3' : 'grid-cols-2 md:grid-cols-3'}`}>
                                        {phaseOptions.map(ing => {
                                            const count = currentSelections.filter(i => i === ing).length;
                                            const isNoLeva = ing === "N√£o leva" || ing === "N√£o";
                                            return (
                                                <button key={ing} onClick={() => handleSelection(ing)} className={`relative p-2 md:p-4 rounded-lg md:rounded-xl font-bold text-xs md:text-sm transition-all active:scale-95 flex items-center justify-center text-center h-24 md:h-32 shadow-sm break-words leading-tight animate-fade-in ${isNoLeva ? "bg-pastel-blue-300 text-white hover:bg-pastel-blue-400" : "bg-white text-slate-700 border-2 border-pastel-blue-200 hover:border-pastel-blue-400 shadow-md hover:shadow-lg"}`}>
                                                    {ing}
                                                    {count > 0 && <span className="absolute -top-2 -right-2 bg-pastel-blue-500 text-white text-xs w-6 h-6 flex items-center justify-center rounded-full border-2 border-white shadow-md z-10">{count}</span>}
                                                </button>
                                            )
                                        })}
                                    </div>
                                </div>
                                <div className="p-3 md:p-4 border-t border-pastel-blue-200/50 bg-pastel-blue-100/40 flex justify-between shrink-0">
                                    <button onClick={resetToHome} className="flex items-center gap-2 text-pastel-blue-500 font-bold text-sm md:text-base hover:bg-pastel-blue-100/50 px-3 py-2 rounded-lg transition-colors"><IconHome size={20} color="#404FC2"/> IN√çCIO</button>
                                    <button onClick={handleUndo} disabled={currentSelections.length === 0} className="flex items-center gap-2 px-4 md:px-6 py-2 bg-white border border-pastel-blue-200 rounded-full font-bold text-pastel-blue-500 disabled:opacity-50 hover:bg-pastel-blue-100 text-sm md:text-base shadow-sm"><IconArrowLeft size={20} color="#404FC2"/> Desfazer</button>
                                </div>
                            </div>
                        )}

                        {gameState === "RESULT_SUCCESS" && (
                            <div className="text-center p-10 bg-pastel-blue-100/95 rounded-3xl shadow-2xl animate-bounce-in mx-4 border border-white/50 max-w-md w-full">
                                <h2 className="text-3xl md:text-4xl font-extrabold text-pastel-green mb-2 drop-shadow-sm">Perfeita! ü§©</h2>
                                <p className="text-lg text-slate-600 mb-6">Sua pontua√ß√£o final:</p>
                                
                                <div className="text-5xl font-black text-pastel-blue-500 mb-6 animate-pulse">{finalScore}</div>

                                {finalScore > highScore.score && (
                                    <div className="mb-4 bg-yellow-100 text-yellow-700 p-2 rounded-lg font-bold text-sm flex items-center justify-center gap-2">
                                        <IconTrophy size={20} className="text-yellow-600"/> NOVO RECORDE!
                                    </div>
                                )}

                                <div className="flex flex-col gap-3">
                                    <label className="text-sm font-bold text-slate-500 text-left">Digite seu nome para salvar:</label>
                                    <input 
                                        type="text" 
                                        value={playerName} 
                                        onChange={(e) => setPlayerName(e.target.value)}
                                        placeholder="Seu Nome" 
                                        className="p-3 rounded-lg border-2 border-pastel-blue-200 focus:border-pastel-blue-500 outline-none text-center font-bold text-lg"
                                        maxLength={12}
                                    />
                                    <button onClick={saveScore} disabled={!playerName.trim()} className="mt-2 bg-pastel-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-pastel-blue-400 transition-all disabled:opacity-50 active:scale-95 flex items-center justify-center gap-2">
                                        Gravar e Voltar
                                    </button>
                                </div>
                            </div>
                        )}

                        {gameState === "RESULT_FAIL" && (
                            <div className="text-center p-6 md:p-10 bg-pastel-blue-100/95 rounded-3xl shadow-2xl animate-shake mx-4 max-h-[80vh] overflow-y-auto custom-scroll border border-white/50">
                                <h2 className="text-2xl md:text-3xl font-extrabold text-pastel-pink-500 mb-4">Eita... üòï</h2>
                                <p className="text-base md:text-lg text-slate-700 mb-6">Alguns ingredientes est√£o incorretos!</p>
                                <div className="bg-white/60 p-4 rounded-lg text-left text-sm text-pastel-pink-500 mb-6 border border-pastel-pink-200">{errorDetails.map((e, i) => <div key={i} className="mb-1">‚Ä¢ {e}</div>)}</div>
                                <button onClick={resetToHome} className="bg-pastel-blue-500 text-white px-8 py-3 rounded-full font-bold shadow-lg hover:bg-pastel-blue-400 transition-transform active:scale-95 flex items-center justify-center gap-2 mx-auto">
                                    <IconRotate size={20} color="#FFF"/> Tentar Novamente
                                </button>
                            </div>
                        )}

                        {gameState === "HOME" && (
                            <div className="hidden md:flex flex-col items-center justify-center text-center bg-pastel-blue-100/40 p-10 rounded-3xl backdrop-blur-sm shadow-xl max-w-lg">
                                <img src="https://storage.googleapis.com/ikona-bucket-production/images/5db193be3ea71a0001bb09f7/EXTENDED%20VERSION_original%20colors-617ac363073e550017b9966b.png" alt="Poke House Logo" className="h-20 mb-6 object-contain" />
                                <p className="text-pastel-blue-500 font-bold text-2xl mb-4">Bem-vindo ao Treino Poke House!</p>
                                <p className="text-slate-700 mb-6">Selecione uma categoria no menu para come√ßar seu treinamento.</p>
                                <div className="mt-4 text-6xl animate-bounce">ü•ó</div>
                            </div>
                        )}
                    </div>
                     {/* VERSION LABEL */}
       <div className="fixed bottom-1 right-2 text-xs text-slate-500/60 font-sans z-50 pointer-events-none select-none">
           v1.16 BETA
       </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById("root"));
        root.render(<App />);
    </script>
</body>
</html>
